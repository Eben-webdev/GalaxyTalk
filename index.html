<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GalaxyTalk</title>

<style>
*{box-sizing:border-box;font-family:Arial,sans-serif}
body{margin:0;background:#0b0f2a;color:#fff;height:100vh;overflow:hidden}
.hidden{display:none}

button{cursor:pointer;background:#6a5cff;color:#fff;border:none;border-radius:6px;padding:8px}

input{
  width:100%;
  padding:10px;
  margin:8px 0;
  border-radius:6px;
  border:none;
}

.error{color:#ff6b6b;font-size:14px;height:16px}

/* Screens */
#siteAccess,#login{
  height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}

.box{
  background:#141a4f;
  padding:25px;
  border-radius:12px;
  width:300px;
  text-align:center;
}

/* Layout */
#app{display:flex;height:100vh}

#sidebar{
  width:260px;
  background:#0f1440;
  display:flex;
  flex-direction:column;
}

#users{
  flex:1;
  overflow-y:auto;
}

.user{
  padding:10px;
  border-bottom:1px solid #222;
  display:flex;
  align-items:center;
  gap:8px;
}

.dot{
  width:8px;
  height:8px;
  border-radius:50%;
  background:#777;
}
.online{background:#4cff4c}

/* Chat */
#chat{flex:1;display:flex;flex-direction:column}

#messages{
  flex:1;
  overflow-y:auto;
  padding:10px;
}

.msg{margin-bottom:6px}
.me{color:#7aa2ff}

#inputBar{
  display:flex;
  padding:10px;
  background:#0f1440;
  gap:6px;
}

#msgInput{flex:1}

/* Settings */
#settingsBtn{
  position:absolute;
  bottom:10px;
  left:10px;
  width:42px;
  height:42px;
  border-radius:50%;
}

#settingsPanel{
  position:absolute;
  bottom:60px;
  left:10px;
  background:#141a4f;
  padding:15px;
  border-radius:10px;
  width:220px;
}
</style>
</head>

<body>

<!-- SITE ACCESS -->
<div id="siteAccess">
  <div class="box">
    <h2>GalaxyTalk</h2>
    <input id="sitePass" type="password">
    <div id="siteErr" class="error"></div>
    <button onclick="checkSite()">Enter</button>
  </div>
</div>

<!-- LOGIN -->
<div id="login" class="hidden">
  <div class="box">
    <h3>Login</h3>
    <input id="userInput">
    <input id="pinInput" type="password">
    <div id="loginErr" class="error"></div>
    <button onclick="loginUser()">Login</button>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <div id="sidebar">
    <div id="users"></div>
  </div>

  <div id="chat">
    <div id="messages"></div>
    <div id="inputBar">
      <input id="msgInput">
      <button onclick="sendMsg()">Send</button>
    </div>
  </div>

  <button id="settingsBtn" onclick="toggleSettings()">âš™</button>

  <div id="settingsPanel" class="hidden">
    <h4>Admin Panel</h4>
    <input id="newUser">
    <input id="newPin">
    <button onclick="addUser()">Add User</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get, push, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

/* ðŸ”¥ Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyB5AN9HLYx59Yue-aNb5ACHFKuy7X7aFPQ",
  authDomain: "galaxytalk-7d3bd.firebaseapp.com",
  databaseURL: "https://galaxytalk-7d3bd-default-rtdb.firebaseio.com",
  projectId: "galaxytalk-7d3bd"
};

const appFB = initializeApp(firebaseConfig);
const db = getDatabase(appFB);

/* ðŸ” Password */
const SITE_PASSWORD = "1886";

/* Elements */
const siteAccess = document.getElementById("siteAccess");
const login = document.getElementById("login");
const app = document.getElementById("app");

const sitePass = document.getElementById("sitePass");
const siteErr = document.getElementById("siteErr");

const userInput = document.getElementById("userInput");
const pinInput = document.getElementById("pinInput");
const loginErr = document.getElementById("loginErr");

const usersDiv = document.getElementById("users");
const messagesDiv = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");

const settingsPanel = document.getElementById("settingsPanel");
const newUser = document.getElementById("newUser");
const newPin = document.getElementById("newPin");

let currentUser = null;

/* âœ… Site Access */
window.checkSite = () => {
  if (sitePass.value.trim() === SITE_PASSWORD) {
    siteAccess.classList.add("hidden");
    login.classList.remove("hidden");
    siteErr.textContent = "";
  } else {
    siteErr.textContent = "Incorrect site password";
  }
};

/* âœ… Login */
window.loginUser = async () => {
  const u = userInput.value.trim();
  const p = pinInput.value.trim();
  if (!u || !p) return;

  const snap = await get(ref(db,"users/"+u));
  if (!snap.exists() || snap.val().pin !== p) {
    loginErr.textContent = "Invalid login";
    return;
  }

  currentUser = u;
  login.classList.add("hidden");
  app.classList.remove("hidden");

  const statusRef = ref(db,"status/"+u);
  set(statusRef,true);
  onDisconnect(statusRef).set(false);

  loadUsers();
  loadMessages();
};

/* ðŸ‘¥ Users */
function loadUsers(){
  onValue(ref(db,"users"), snap=>{
    usersDiv.innerHTML="";
    snap.forEach(u=>{
      const row=document.createElement("div");
      row.className="user";
      row.innerHTML=`<div class="dot" id="dot-${u.key}"></div>${u.key}`;
      usersDiv.appendChild(row);

      onValue(ref(db,"status/"+u.key), s=>{
        const dot=document.getElementById("dot-"+u.key);
        if(dot) dot.classList.toggle("online",s.val()===true);
      });
    });
  });
}

/* ðŸ’¬ Messages */
function loadMessages(){
  onValue(ref(db,"messages/global"), snap=>{
    messagesDiv.innerHTML="";
    snap.forEach(m=>{
      const d=document.createElement("div");
      d.className="msg"+(m.val().user===currentUser?" me":"");
      d.textContent=`${m.val().user}: ${m.val().text}`;
      messagesDiv.appendChild(d);
    });
    messagesDiv.scrollTop=messagesDiv.scrollHeight;
  });
}

window.sendMsg = () => {
  if (!msgInput.value.trim()) return;
  push(ref(db,"messages/global"),{
    user:currentUser,
    text:msgInput.value
  });
  msgInput.value="";
};

/* âš™ Admin */
window.toggleSettings = () => {
  if(currentUser!=="Elnathan") return;
  settingsPanel.classList.toggle("hidden");
};

window.addUser = () => {
  if(currentUser!=="Elnathan") return;
  set(ref(db,"users/"+newUser.value),{
    pin:newPin.value
  });
};
</script>

</body>
</html>
