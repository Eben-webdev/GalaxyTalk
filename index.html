<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GalaxyTalk</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;font-family:Arial,sans-serif}
body{margin:0;background:black;color:#eee;height:100vh;overflow:hidden}
canvas{position:fixed;inset:0;z-index:-1}

.hidden{display:none}
.error{color:#ff6b6b;font-size:14px;height:16px}

/* CENTER CARDS */
.center{height:100vh;display:flex;align-items:center;justify-content:center}
.card{
  background:rgba(60,0,90,.85);
  padding:25px;
  border-radius:12px;
  width:320px;
  box-shadow:0 0 25px purple;
  text-align:center
}
input,button{
  width:100%;
  padding:10px;
  margin-top:10px;
  border-radius:6px;
  border:none
}
button{background:black;color:white;border:1px solid purple;cursor:pointer}
button:hover{background:purple}

/* APP */
#app{display:flex;height:100vh}
#sidebar{
  width:260px;
  background:#120018;
  display:flex;
  flex-direction:column
}
.user{
  padding:10px;
  border-bottom:1px solid #222;
  display:flex;
  align-items:center;
  gap:8px;
  cursor:pointer
}
.status{width:8px;height:8px;border-radius:50%}
.online{background:#4cff4c}
.offline{background:#666}

#chat{flex:1;display:flex;flex-direction:column}
#messages{flex:1;padding:10px;overflow-y:auto}
.msg{background:rgba(128,0,128,.35);padding:6px;border-radius:6px;margin-bottom:6px}
.me{border:1px solid #7aa2ff}

#typing{height:20px;font-style:italic;color:#aaa}
.dot{animation:blink 1.4s infinite both}
.dot:nth-child(2){animation-delay:.2s}
.dot:nth-child(3){animation-delay:.4s}
@keyframes blink{0%{opacity:0}20%{opacity:1}100%{opacity:0}}

#inputBar{display:flex;gap:6px;padding:10px}
#msgInput{flex:1;padding:14px;border-radius:6px;border:none}
#sendBtn{width:60px}

/* SETTINGS */
#settingsBtn{
  position:absolute;
  bottom:12px;
  left:12px;
  width:42px;
  height:42px;
  border-radius:50%;
  background:purple;
  color:white;
  font-size:18px
}
#settingsOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  z-index:50
}
#settingsPanel{
  position:fixed;
  top:0;
  right:-320px;
  width:320px;
  height:100%;
  background:#1e1f2b;
  padding:20px;
  transition:.3s;
  z-index:51
}
#settingsPanel.open{right:0}
.closeBtn{position:absolute;top:10px;right:10px;cursor:pointer}
</style>
</head>

<body>

<canvas id="space"></canvas>

<!-- SITE ACCESS -->
<div id="siteAccess" class="center">
  <div class="card">
    <h2>GalaxyTalk</h2>
    <input id="sitePass" type="password" placeholder="Site password">
    <div id="siteErr" class="error"></div>
    <button onclick="checkSite()">Enter</button>
  </div>
</div>

<!-- LOGIN -->
<div id="login" class="center hidden">
  <div class="card">
    <h3>Login</h3>
    <input id="username" placeholder="Username">
    <input id="pin" type="password" placeholder="4-digit PIN">
    <div id="loginErr" class="error"></div>
    <button onclick="login()">Login</button>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <div id="sidebar"></div>

  <div id="chat">
    <div id="messages"></div>
    <div id="typing">
      <span id="typingText"></span>
      <span class="dot">.</span><span class="dot">.</span><span class="dot">.</span>
    </div>
    <div id="inputBar">
      <input id="msgInput" placeholder="Message">
      <button id="sendBtn" onclick="sendMsg()">Send</button>
    </div>
  </div>

  <button id="settingsBtn" onclick="toggleSettings()">âš™</button>
</div>

<!-- SETTINGS -->
<div id="settingsOverlay" onclick="toggleSettings()"></div>
<div id="settingsPanel">
  <div class="closeBtn" onclick="toggleSettings()">âœ–</div>
  <h3>Settings</h3>
  <button onclick="logout()">Logout</button>
  <div id="adminPanel" class="hidden">
    <h4>Admin</h4>
    <input id="newUser" placeholder="Username">
    <input id="newPin" placeholder="PIN">
    <button onclick="addUser()">Add User</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getDatabase, ref, push, onValue, set, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

/* USERS */
const USERS={
"Faheemah":"9846","SamuelR":"5891","SamuelC":"2339","Ethan":"8213",
"Elnathan":"9999","Caroline":"4006","Molly":"2296","Zara":"6701",
"Danny":"7494","Shell-Lee":"0754","Raygan":"5124","Jacob":"7596",
"Nathan":"2006","Kiera":"4888","Karter":"1115","Meadleen":"5565",
"Eli":"0758","Hadlee":"9160"
};

const SITE_PASSWORD="1886";

const firebaseConfig={
  apiKey:"AIzaSyB5AN9HLYx59Yue-aNb5ACHFKuy7X7aFPQ",
  authDomain:"galaxytalk-7d3bd.firebaseapp.com",
  databaseURL:"https://galaxytalk-7d3bd-default-rtdb.firebaseio.com",
  projectId:"galaxytalk-7d3bd"
};

const appFB=initializeApp(firebaseConfig);
const db=getDatabase(appFB);

let currentUser=null;
let currentChat="group/main";

/* ACCESS */
window.checkSite=()=>{
  if(sitePass.value===SITE_PASSWORD){
    siteAccess.classList.add("hidden");
    login.classList.remove("hidden");
  }else siteErr.textContent="Wrong site password";
};

/* LOGIN */
window.login=()=>{
  const u=username.value.trim();
  const p=pin.value.trim();
  if(!USERS[u]||USERS[u]!==p){
    loginErr.textContent="Invalid login";
    return;
  }
  currentUser=u;
  login.classList.add("hidden");
  app.classList.remove("hidden");

  if(u==="Elnathan") adminPanel.classList.remove("hidden");

  set(ref(db,"status/"+u),true);
  onDisconnect(ref(db,"status/"+u)).set(false);

  loadUsers();
  listenMessages();
};

/* USERS LIST */
function loadUsers(){
  sidebar.innerHTML="";
  const g=document.createElement("div");
  g.className="user";
  g.textContent="ðŸ‘¥ Group Chat";
  g.onclick=()=>openGroup();
  sidebar.appendChild(g);

  Object.keys(USERS).forEach(u=>{
    if(u===currentUser) return;
    const d=document.createElement("div");
    d.className="user";
    const s=document.createElement("div");
    s.className="status offline";
    d.appendChild(s);
    d.append(u);
    d.onclick=()=>openDM(u);
    sidebar.appendChild(d);

    onValue(ref(db,"status/"+u),snap=>{
      s.className="status "+(snap.val()?"online":"offline");
    });
  });
}

function openDM(u){
  currentChat="dm/"+[currentUser,u].sort().join("_");
  listenMessages();
}
function openGroup(){
  currentChat="group/main";
  listenMessages();
}

/* MESSAGES */
function listenMessages(){
  messages.innerHTML="";
  onValue(ref(db,"messages/"+currentChat),snap=>{
    messages.innerHTML="";
    snap.forEach(m=>{
      const d=document.createElement("div");
      d.className="msg"+(m.val().user===currentUser?" me":"");
      d.textContent=`${m.val().user}: ${m.val().text}`;
      if(m.val().user===currentUser){
        d.onclick=()=>{ if(confirm("Delete?")) remove(ref(db,"messages/"+currentChat+"/"+m.key)); };
      }
      messages.appendChild(d);
    });
    messages.scrollTop=messages.scrollHeight;
  });
}

window.sendMsg=()=>{
  if(!msgInput.value.trim())return;
  push(ref(db,"messages/"+currentChat),{user:currentUser,text:msgInput.value});
  msgInput.value="";
};

/* SETTINGS */
window.toggleSettings=()=>{
  settingsPanel.classList.toggle("open");
  settingsOverlay.style.display=settingsPanel.classList.contains("open")?"block":"none";
};
window.logout=()=>location.reload();
window.addUser=()=>USERS[newUser.value]=newPin.value;
</script>

<script>
const c=document.getElementById("space"),ctx=c.getContext("2d");
function resize(){c.width=innerWidth;c.height=innerHeight}
window.onresize=resize;resize();
let stars=[...Array(200)].map(()=>({x:Math.random()*c.width,y:Math.random()*c.height,r:Math.random()*1.5,a:Math.random()}));
(function anim(){
  ctx.clearRect(0,0,c.width,c.height);
  stars.forEach(s=>{
    s.a+=(Math.random()-.5)*.05;
    s.a=Math.max(0,Math.min(1,s.a));
    ctx.fillStyle=`rgba(255,255,255,${s.a})`;
    ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();
  });
  requestAnimationFrame(anim);
})();
</script>

</body>
</html>
