<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Purple Space Chat</title>
<style>
* { box-sizing: border-box; font-family: Arial, sans-serif; }
body { margin: 0; background: black; color: #eee; overflow: hidden; }
canvas { position: fixed; inset: 0; z-index: -1; }

.card { background: rgba(60,0,90,0.85); padding: 25px; border-radius: 12px; width: 360px; box-shadow: 0 0 25px purple; }
input, button { width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; border: none; }
button { background: black; color: white; border: 1px solid purple; cursor: pointer; }
button:hover { background: purple; }

.error { color:red; margin-top:8px; display:block; }

#siteAccess, #login, #app { height:100vh; display:flex; align-items:center; justify-content:center; flex-direction: column; }

#app { display:none; width:100%; flex-direction: column; }
#layout { display: flex; height: 100%; }
#sidebar { width: 260px; background: #120018; padding: 10px; overflow-y: auto; }
.sidebarItem { padding: 6px; border-radius: 4px; cursor: pointer; }
.sidebarItem:hover { background: rgba(128,0,128,0.3); }
.sidebarItem.active { background: purple; color: white; font-weight: bold; }

#chatArea { flex:1; display:flex; flex-direction: column; }
#messages { flex:1; padding:10px; overflow-y:auto; }
.msg { background: rgba(128,0,128,0.4); padding:6px; margin-bottom:6px; border-radius:6px; }
footer { display:flex; gap:6px; padding:10px; }
</style>
</head>
<body>
<canvas id="space"></canvas>

<!-- SITE ACCESS PASSWORD -->
<div id="siteAccess">
  <div class="card">
    <h2>Enter Site Password</h2>
    <input id="sitePass" type="password">
    <div id="siteError" class="error" style="display:none;"></div>
    <button onclick="checkSitePass()">Enter</button>
  </div>
</div>

<!-- LOGIN -->
<div id="login">
  <div class="card">
    <h2>Login</h2>
    <input id="loginUser" placeholder="Username">
    <input id="loginPass" type="password">
    <div id="loginError" class="error" style="display:none;"></div>
    <button onclick="login()">Login</button>
  </div>
</div>

<!-- CHAT APP -->
<div id="app">
  <div id="layout">
    <div id="sidebar">
      <h3>üåç Global</h3>
      <div id="globalChat" class="sidebarItem">Everyone</div>
      <h3>üí¨ Users</h3>
      <div id="usersList"></div>
    </div>
    <div id="chatArea">
      <div id="messages"></div>
      <footer>
        <input id="msgInput" placeholder="Message...">
        <button onclick="sendMessage()">Send</button>
      </footer>
    </div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getDatabase, ref, push, onValue, set } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

// --- FIREBASE CONFIG ---
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT.firebaseio.com",
  projectId: "YOUR_PROJECT_ID"
};

const fb = initializeApp(firebaseConfig);
const db = getDatabase(fb);

// --- USERS ---
let usersDB = {
  "Faheemah": "9846",
  "SamuelR": "5891",
  "SamuelC": "2339",
  "Ethan": "8213",
  "Elnathan": "9999",
  "Caroline": "4006",
  "Molly": "2296",
  "Zara": "6701",
  "Danny": "7494",
  "Shell-Lee": "0754",
  "Raygan": "5124",
  "Jacob": "7596",
  "Nathan": "2006",
  "Kiera": "4888",
  "Karter": "1115",
  "Meadleen": "5565",
  "Eli": "0758",
  "Hadlee": "9160"
};

let currentUser = null;
let currentChat = 'global';

// --- SITE ACCESS ---
const SITE_PASSWORD = "1886";
function checkSitePass() {
  const val = document.getElementById('sitePass').value.trim();
  const err = document.getElementById('siteError');
  if(val === SITE_PASSWORD){
    document.getElementById('siteAccess').style.display = 'none';
    document.getElementById('login').style.display = 'flex';
    err.style.display = 'none';
  } else {
    err.textContent = "Wrong site password";
    err.style.display = "block";
  }
}

// --- LOGIN ---
function login() {
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  const err = document.getElementById('loginError');
  if(usersDB[u] && usersDB[u] === p){
    currentUser = u;
    // Add user to Firebase if not exists
    set(ref(db, 'users/' + currentUser), { name: currentUser });
    document.getElementById('login').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    renderSidebarUsers();
    openGlobal();
    err.style.display = 'none';
  } else {
    err.textContent = "Wrong username or PIN";
    err.style.display = 'block';
  }
}

// --- SIDEBAR ---
function renderSidebarUsers(){
  const list=document.getElementById('usersList');
  list.innerHTML='';
  Object.keys(usersDB).forEach(u=>{
    if(u!==currentUser){
      const div=document.createElement('div');
      div.className='sidebarItem';
      div.textContent=u;
      div.onclick=()=>{
        currentChat=[currentUser,u].sort().join('_');
        setActiveChat(div);
        listenMessages('dm/' + currentChat);
      };
      list.appendChild(div);
    }
  });
  setActiveChat(currentChat==='global'?document.getElementById('globalChat'):null);
}

function setActiveChat(el){
  document.querySelectorAll('.sidebarItem').forEach(x=>x.classList.remove('active'));
  document.getElementById('globalChat').classList.remove('active');
  if(el) el.classList.add('active');
}

document.getElementById('globalChat').onclick=openGlobal;

function openGlobal(){
  currentChat='global';
  setActiveChat(document.getElementById('globalChat'));
  listenMessages('global');
}

// --- MESSAGES ---
function listenMessages(path){
  const messagesEl = document.getElementById('messages');
  messagesEl.innerHTML='';
  const messagesRef = ref(db, 'messages/' + path);
  onValue(messagesRef, snap=>{
    messagesEl.innerHTML='';
    snap.forEach(m=>{
      const d = document.createElement('div');
      d.className='msg';
      d.textContent=m.val().user + ': ' + m.val().text;
      messagesEl.appendChild(d);
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
  });
}

window.sendMessage = ()=>{
  const val = document.getElementById('msgInput').value.trim();
  if(!val) return;
  const path = currentChat==='global' ? 'global' : 'dm/' + currentChat;
  push(ref(db, 'messages/' + path), { user: currentUser, text: val });
  document.getElementById('msgInput').value='';
}
</script>

<!-- STARFIELD -->
<script>
const c=document.getElementById('space');
const ctx=c.getContext('2d');
function resize(){c.width=innerWidth;c.height=innerHeight;}
window.onresize=resize; resize();
let stars=Array.from({length:200},()=>({x:Math.random()*c.width,y:Math.random()*c.height,r:Math.random()*1.5,a:Math.random()}));
(function anim(){
  ctx.clearRect(0,0,c.width,c.height);
  stars.forEach(s=>{
    s.a += (Math.random()-0.5)*0.05;
    s.a=Math.max(0,Math.min(1,s.a));
    ctx.fillStyle=`rgba(255,255,255,${s.a})`;
    ctx.beginPath();
    ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
    ctx.fill();
  });
  requestAnimationFrame(anim);
})();
</script>
</body>
</html>
